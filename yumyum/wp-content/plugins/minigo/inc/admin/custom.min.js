jQuery(function($) {
    'use strict';
    
    var form,
        fieldset = jQuery('.minigo_subscriber_list_form'),
        textarea = fieldset.find('textarea'),
        submit = fieldset.find('input[type="submit"]'),
        takeSpans = jQuery('body.wp-admin #pt_minigo-switch-themes ul li span'),
        JSONpath = '../wp-content/plugins/minigo/inc/admin/skins/';

    var spanCount = jQuery('body.wp-admin #pt_minigo-switch-themes ul li').length;
    var stickySide = false;

	/* Skin*/
    takeSpans.each(function(spanCount) {
        var that = jQuery(this);
        var spanSlice = that.text().split(' - ');
        // var skinAppend = jQuery('<div class="skin-text"><span>Skin</span> #' + ++spanCount + '</div>');
        var skinAppend = jQuery('<div class="skin-text"><span>Base</span> #' + ++spanCount + '</div>');

        skinAppend.appendTo(that.parents('label'));
        jQuery('<div class="skin-images"></div><div class="skin-zoom"></div>').prependTo(that.parents('label'));
        jQuery('<a target="_blank" href="http://premiothemes.com/minigo/demo/wp-plugin/demo-' + ("0" + spanCount).slice(-2) + '.html" class="button skin-preview"><i class="fa fa-eye"></i> Preview</a><a class="button demo-content-mod"><i class="fa fa-cloud-download"></i>Load</a>').appendTo(that.parents('label'));
        that.text(spanSlice[0]).css({ 'font-weight': 'bold' }).addClass('skin-title');
        jQuery('<span>' + spanSlice[1] + '</span>').insertAfter(that);

    });

    jQuery('body.wp-admin #pt_minigo-switch-themes ul li label').each(function() {
        if (jQuery(this).children('input').is(':checked')) {
            jQuery(this).parent().addClass('active-field');
        }

    });

	/* Skin Preview */
	jQuery('.skin-images').on('hover', function() {
		jQuery(this).parent().find('.skin-zoom').toggleClass('skin-zoom--show');
		// jQuery('.skin-images').not(this).toggleClass('skin-images--disabled');
	});

    /* Modal Skins */
    jQuery('.demo-content-mod').each(function() {

        var disclaimer = 'This is a disclaimer text demo',
            skinModalTitle = '<h1>Demo Loader: ' + jQuery(this).parents('label').children('.skin-title').text() + '</h1>',
            skinModalSubtitle = '<span>This feature allows you to replicate our demo for this file.</span>',
            skinModalInformation = '<p>We craft each one of our theme skins with great care in the hopes of saving some set-up time.<br>So, if you want to use this skin as a base, you can import all our settings and assets, then proceed to customizing it to your needs.</p>',
            disclaimerInfo = '<div class="notice-yellow"><div class="skin-notice-icon"><i class="fa fa-warning"></i></div><h5>Note: Importing a demo will overwrite all MiniGO settings!</h5><p>If this is a fresh instalation ignore this warning, however if you already added text youâ€™d like to keep,<br> either back it up in a text file or use the Import/Export feature.</p></div>';

        jQuery(this).on('click', function() {

			jQuery(this).parent().find('.skin-zoom').addClass('skin-zoom--fixed');
        	
            var skinModModal = jQuery('<div id="' + jQuery(this).parents('label').children('input.radio').val() + '" class="skin-modal-holder"><div class="skin-modal-body"><div class="modal-body">' + skinModalTitle + '' + skinModalSubtitle + '' + skinModalInformation + '' + disclaimerInfo + '<span class="copy-options">Copy options to your server ?</span><div class="import-switcher"><a href="javascript:void(0);" class="button">Yes</a><a href="javascript:void(0);" class="button disable">No</a></div></div><div class="modal-buttons"><a href="javascript:void(0);" class="skin-closer button"><i class="fa fa-remove"></i>Cancel</a><a href="javascript:void(0);" class="skin-import-btn button preview_btn disabled"><i class="fa fa-check"></i>Confirm</a></div></div><div class="skin-modal-overlay"></div><div class="loading--animation"><i class="fa fa-cog fa-spin fa-3x fa-fw"></i><span class="loading-title">Loading Skin, please wait.</span><span class="loading-help"><i class="fa fa-info-circle icon-loading-help"></i>If you get a confirmation pop-up, click "Leave Page".</span></div></div>');
            skinModModal.appendTo('body');

            jQuery('.skin-closer, .skin-modal-overlay').on('click', function() {
                jQuery('.skin-zoom--fixed').fadeOut(200, function() {
                    jQuery(this).removeClass('skin-zoom--fixed').attr('style', '');
                });            	
                jQuery('.skin-modal-holder').fadeOut(400, function() {
                    skinModModal.remove();
                });
            });

            jQuery('.modal-body .import-switcher > a:first-child').on('click', function() {
                jQuery(this).addClass('enable');
                jQuery('.modal-body .import-switcher > a:last-child').removeClass('disable');
                jQuery('.skin-import-btn').removeClass('disabled');
            });
            jQuery('.modal-body .import-switcher > a:last-child').on('click', function() {
                jQuery(this).addClass('disable');
                jQuery('.modal-body .import-switcher > a:first-child').removeClass('enable');
                jQuery('.skin-import-btn').addClass('disabled');
            });

            jQuery('.skin-import-btn').on('click', function() {

            	var skinKey = jQuery('.skin-modal-holder').attr('id'),
            		skinWelding = JSONpath + skinKey + '.json';

            	if (!jQuery(this).hasClass('disabled')) {

                    $('.skin-modal-holder').addClass('skin--loading');
                    // Inject JSON
                    $.getJSON(skinWelding, function(data) {
            		    jQuery('textarea#import-code-value').val(JSON.stringify(data));
            		    jQuery('.modal-body').addClass('importing--skin');
            		    setTimeout(function() {
            		        jQuery('#redux-import').trigger('click');
            		    }, 300);

	            	});

        		}
        	});

        });
    });

    /* Subscribers List */
    setTimeout(function() {
        form = jQuery('<form action="' + window.location.href + '" method="post"></form>');
        fieldset.wrap(form);
        form = fieldset.parent();

        form.on('submit', function(e) {
            fieldset.find('textarea').attr('name', 'minigo_subscriber_list');
            form.off(e);
            form.submit();
        });
    }, 2000);
    textarea.off('change click submit');
    submit.off('click submit change');

    // Suppress Page Reload Dialog
    window.onbeforeunload = unloadFunction;
    function unloadFunction() {
        return null;
    }

    /* Top icons */
    $('#redux-header').append($('.premiothemes-logo')).append('<div class="nav-icons">' +
        '<div class="vr"></div>' +
        '<a href="mailto:hello@premiothemes.com"><i class="fa fa-pencil-square-o"></i><span>E-mail Support</span></a>' +
        '<a href="http://themeforest.net/user/PremioThemes?ref=PremioThemes" target="_blank"><i class="fa fa-star"></i><span>ThemeForest Portfolio</span></a>' +
        '<div class="vr"></div>' +
        '<a href="https://www.facebook.com/PremioThemes" target="_blank"><i class="fa fa-facebook-square"></i><span>Facebook</span></a>' +
        '<a href="https://twitter.com/PremioThemes" target="_blank"><i class="fa fa-twitter-square"></i><span>Twitter</span></a>' +
        '<a href="https://www.pinterest.com/PremioThemes/" target="_blank"><i class="fa fa-pinterest"></i><span>Pinterest</span></a>' +
        '<a href="https://www.behance.net/PremioThemes" target="_blank"><i class="fa fa-behance"></i><span>Behance</span></a>' +
        '<a href="https://www.youtube.com/channel/UCsVztxXlDTQsLxgr2AVa31Q" target="_blank"><i class="fa fa-youtube-square"></i><span>Youtube</span></a>' +
        '<a href="https://www.linkedin.com/company/4994120" target="_blank"><i class="fa fa-linkedin"></i><span>Linkedin</span></a>' +
        '<div class="vr"></div>' +
        '</div>');
    $('.premiothemes-logo').addClass('show-logo');

    /* Sticky Side Nav Bar */
    // var wpBarHeight = $('#wpadminbar').height(),
    //     topBarOffset = wpBarHeight + 10,
    //     menuOffset = wpBarHeight + 50,
    //     buttonsOffset = menuOffset + 50,
    //     // menuHeight = $('.redux-group-menu').height(),
    //     // windowHeight = $(window).height(),
    //     originalMenuTop = $('.redux-group-menu').offset().top,
    //     originalMenuWidth = $('.redux-group-menu').width(),
    //     originalInfoLeft = $('#redux-intro-text').offset().left,
    //     originalBarTop = $('#redux-sticky').offset().top,
    //     originalBarLeft = $('#redux-sticky').offset().right,
    //     originalBarWidth = $('#redux-sticky').width();

    // $('.redux-sidebar').prepend('<div class="scroll-top-holder"><a href="" class="scroll-top-link"><i class="el el-chevron-up scroll-top-icon"></i><span class="scroll-top-label">Scroll to top</span></a></div>');

    // if (stickySide) {
    //     $(window).scroll(function() {
    //         // console.log('We sense scroll');
    //         // console.log('menuHeight: ' + $('.redux-group-menu').height() + ' | containerHeight: ' + $('.redux-main').height() + ' | mH-cH: ' + ($('.redux-main').height() - $('.redux-group-menu').height())+ ' sidebarHeight: ' + $('.redux-sidebar').height() + ' | windowHeight: ' + $(window).height() + ' | innerHeight: ' + window.innerHeight);
    //         // Only Apply Sticky when the height of the nav is smaller than that of the window. Perhaps add some viewport size limitations?
    //         if ( ( $(window).innerWidth() >= 1366)  && ($('.redux-group-menu').height() < $(window).height()) && ($('.redux-group-menu').height() < ($('.redux-main').height() - 205) )) {
    //             console.log("We're checking for sticky :)");
    //             (function stickBars() {
    //                 var elementTop = $('#redux-sticky').offset().top;

    //                 if (($(window).scrollTop() >= (elementTop - wpBarHeight)) && ($(window).scrollTop() > originalBarTop)) {
    //                     $('.redux-group-menu').addClass('redux-group-menu-fixed').css('top', menuOffset + 'px').css('width', originalMenuWidth + 'px');
    //                     $('#redux-sticky').addClass('redux-sticky-fixed').css('top', topBarOffset + 'px').css('width', ($('.redux-main').outerWidth() - 1) + 'px');
    //                     $('#redux-intro-text').addClass('redux-intro-bar-fixed').css('top', topBarOffset + 'px').css('left', originalInfoLeft + 'px');

    //                     if ($('.scroll-top-holder').css('display', 'none')) {
    //                         $('.scroll-top-holder').css('top', wpBarHeight + 'px').css('display', 'block');
    //                         $('.scroll-top-holder').addClass('scroll-top-show');
    //                     }

    //                 } else {
    //                     $('.redux-group-menu').removeClass('redux-group-menu-fixed').removeAttr('style');
    //                     $('#redux-sticky').removeClass('redux-sticky-fixed').removeAttr('style');
    //                     $('#redux-intro-text').removeClass('redux-intro-bar-fixed').removeAttr('style');

    //                     if ($('.scroll-top-holder').css('display', 'block')) {
    //                         $('.scroll-top-holder').css('display', 'none');
    //                     }

    //                 }
    //             })();
    //         }
    //     });
    // }



    /* Footer buttons */
    // $('#redux-footer').prepend('<div class="minigo-footer-buttons"></div>');
    // $('.minigo-footer-buttons').append($('#redux-intro-text .button').clone());
    // $('.minigo-footer-buttons').append($('#redux-intro-text .button').clone());
    // $('#redux-footer .redux-action_bar #redux_save').before('<i class="fa fa-save save-icon"></i>');


    /* Save Button */
    // Add Icon to Save Button
    // $('#redux_save').each(function(){
    //     $(this).before('<i class="fa fa-save save-icon"></i>');
    //     $(this).addClass('save-icon--loaded');
    // })
    // $('#redux-footer .redux-action_bar #redux_save').each(function(){
    //     $(this).before('<i class="fa fa-save save-icon"></i>');
    //     $(this).addClass('save-icon--loaded');
    // })

    // $('#redux_save').hover(function() {
    //     $(this).parent().find('.save-icon').toggleClass('save-icon--hover');

    // });
    // $('#redux_save').click(function() {
    //     $(this).parent().find('.save-icon').removeClass('save-icon--hover');

    // });
    // $('#redux-footer .redux-action_bar #redux_save').hover(function() {
    //     $(this).parent().find('.save-icon').toggleClass('save-icon--hover');

    // });
    // $('#redux-footer .redux-action_bar #redux_save').click(function() {
    //     $(this).parent().find('.save-icon').removeClass('save-icon--hover');

    // });

    // /* Footer buttons */
    $('#redux-footer').prepend('<div class="minigo-footer-buttons"></div>');
    // $('.minigo-footer-buttons').append($('#redux-intro-text .button').clone());
    $('.minigo-footer-buttons').append($('#redux-intro-text .button').clone());
    $('.redux-action_bar #redux_save').before('<i class="fa fa-save save-icon"></i>');

    /* Fix Save Warning Notification Offset */
    $('.redux-save-warn').removeAttr('style');

    /* Animate to top when the scroll button is clicked */
    var scrollTop = $(".scroll-top-link");

    $(window).scroll(function() {
        var topPos = $(this).scrollTop();
    });

    $(scrollTop).click(function() {
        $('html, body').animate({
            scrollTop: 0
        }, 500);
        return false;
    });

    // Scroll to top each time we click on an option
    $('.redux-group-tab-link-a').click(function(){
        // $('html, body').animate({
        $('html, body').animate({
            scrollTop: 0
        }, 300);
        return false;
    });
    // $('.redux-group-tab-link-a').click().scrollTop();


    /* Resize Action Bar when the Browser does */
    $(window).resize(function() {
        if ($('#redux-sticky').hasClass('redux-sticky-fixed')) {
            $('#redux-sticky').css('width', ($('.redux-main').outerWidth() - 1) + 'px');
        }
    });

    /* Fix for wrong wp_editor height */
    $(window).on('load', function() {
        setTimeout(function() {
            var editors = $('.mceIframeContainer iframe');
            if (!editors.length) {
                return;
            }

            editors.each(function() {
                var el = $(this);

                if (el.css('height') !== '28px') {
                    return;
                }

                el.css('height', '300px').parents('.mceLayout').css('height', '');
            });
        }, 1000)
    });

});
